<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Search and Calorie Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <!-- Google Font (San Francisco like font) -->
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:wght@300;400;500;600&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Telegram Web Apps JS SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: #f5f5f7;
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding-top: 50px;
      position: relative;
    }
    .card {
      border: none;
      border-radius: 20px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      overflow: hidden;
    }
    .card-header {
      background-color: #f9f9f9;
      padding: 25px;
      font-size: 1.6rem;
      text-align: center;
      font-weight: 600;
      color: #333;
      border-bottom: 1px solid #eaeaea;
    }
    .form-label {
      font-weight: 500;
      color: #333;
    }
    .form-control {
      border-radius: 15px;
      border: 1px solid #ddd;
      padding: 12px;
      font-size: 1rem;
      box-sizing: border-box;
      margin-bottom: 15px;
    }
    .form-control:focus {
      border-color: #007aff;
      box-shadow: 0 0 5px rgba(0, 122, 255, 0.5);
    }
    .btn {
      border-radius: 15px;
      padding: 12px;
      font-weight: 600;
      font-size: 1rem;
    }
    .btn-primary {
      background-color: #007aff;
      border: none;
      color: #fff;
    }
    .btn-primary:hover {
      background-color: #005bb5;
    }
    .alert {
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      font-size: 1.1rem;
      margin-top: 20px;
    }
    .alert-info {
      background-color: #eaf4ff;
      color: #007aff;
    }
    .alert-danger {
      background-color: #ffeaea;
      color: #ff3b30;
    }
    #languageSelect {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background-color: #fff;
      border: 1px solid #ddd;
      padding: 8px 15px;
      border-radius: 15px;
      font-size: 1rem;
      cursor: pointer;
    }
    #searchResults {
      max-height: 250px;
      overflow-y: auto;
    }
    .search-item {
      padding: 15px;
      border-bottom: 1px solid #f0f0f5;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .search-item:hover {
      background-color: #f7f7f8;
    }
    #productSearch {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <select id="languageSelect">
    <option value="en">English</option>
    <option value="ru">Русский</option>
    <option value="fr">Français</option>
    <option value="de">Deutsch</option>
    <option value="es">Español</option>
    <option value="it">Italiano</option>
  </select>

  <div class="container">
    <!-- Блок поиска продуктов -->
    <div class="card mb-4">
      <div class="card-header" id="productSearchTitle">Product Search</div>
      <div class="card-body">
        <input type="text" class="form-control mb-3" id="productSearch" placeholder="Search for products..." oninput="debouncedSearch()">
        <div id="searchResults"></div>
        <form id="productForm" style="display: none;">
          <div class="mb-3">
            <label for="product" class="form-label" id="productLabel">Product</label>
            <input type="text" class="form-control" id="product" readonly>
          </div>
          <div class="mb-3">
            <label for="weight" class="form-label" id="weightLabel">Weight (grams)</label>
            <input type="number" class="form-control" id="weight" placeholder="Enter weight">
          </div>
<div class="d-grid mb-3">
            <button type="button" class="btn btn-primary" onclick="calculateCalories()" id="calculateButton">Calculate</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Результат расчёта калорий -->
    <div class="alert alert-info text-center" id="result" role="alert">
      Result will appear here
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    // Перевод интерфейса
    const translateApiUrl = "https://libretranslate.de/translate";
    let selectedLang = localStorage.getItem("lang") || "en";
    document.getElementById("languageSelect").value = selectedLang;

    // Загружаем данные из localStorage
    let productData = JSON.parse(localStorage.getItem("productData")) || [];
    let history = JSON.parse(localStorage.getItem("calorieHistory")) || [];
    let productTranslations = JSON.parse(localStorage.getItem("productTranslations")) || {};

    // Дебаунсинг для поиска
    let searchTimeout;
    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(searchProducts, 500);
    }

    // Поиск продуктов с использованием Open Food Facts API
    async function searchProducts() {
      const query = document.getElementById('productSearch').value.trim();
      if (!query) {
        document.getElementById('searchResults').innerHTML = '';
        return;
      }

      // Проверка кешированных данных
      const cachedResults = JSON.parse(localStorage.getItem(`search_${query}`));
      if (cachedResults) {
        displaySearchResults(cachedResults);
        return;
      }

      const res = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${query}&search_simple=1&action=process&json=1&sort_by=popularity&json=1`);
      const data = await res.json();
      const products = data.products || [];

      // Ограничиваем количество результатов до 10
      const limitedProducts = products.slice(0, 10);
      
      // Сохранение результатов в кеш
      localStorage.setItem(`search_${query}`, JSON.stringify(limitedProducts));

      displaySearchResults(limitedProducts);
    }

    // Отображение результатов поиска
    function displaySearchResults(products) {
      let resultsHtml = '';
      products.forEach(product => {
        const productName = product.product_name || 'Unknown product';
        resultsHtml += `
          <div class="search-item" onclick="selectProduct('${productName}')">
            ${productName}
          </div>
        `;
      });

      document.getElementById('searchResults').innerHTML = resultsHtml;
    }

    // Выбор продукта
    function selectProduct(productName) {
      document.getElementById('product').value = productName;
      document.getElementById('productForm').style.display = 'block';
      document.getElementById('searchResults').innerHTML = ''; // Скрыть результаты поиска
    }

    // Расчёт калорий (если данные о калориях есть в данных продукта)
    function calculateCalories() {
      const weight = parseFloat(document.getElementById('weight').value);
      const productName = document.getElementById('product').value;

      if (!weight || !productName) {
        document.getElementById("result").innerHTML = "Please select a product and enter a valid weight.";
        return;
      }

      // Получение калорий с Open Food Facts (примерно)
      const product = productData.find(p => p.name === productName);
      if (!product || !product.calories) {
        document.getElementById("result").innerHTML = "No calorie information available for this product.";
        return;
      }

      const calories = (product.calories / 100) * weight;
      document.getElementById("result").innerHTML = `You consumed ${calories.toFixed(2)} calories from ${productName}.`;
      saveHistory(productName, weight, calories);
    }

    // Сохранение истории
    function saveHistory(productName, weight, calories) {
      history.push({ productName, weight, calories });
      localStorage.setItem("calorieHistory", JSON.stringify(history));
    }

    // Перевод интерфейса
    async function translateInterface() {
      const labels = {
        productSearchTitle: "Product Search",
        productLabel: "Product",
        weightLabel: "Weight (grams)",
        calculateButton: "Calculate",
        result: "Result will appear here"
      };
      for (let id in labels) {
        const translated = await translateText(labels[id], selectedLang);
        document.getElementById(id).innerText = translated;
      }
    }

    // Обработчик изменения языка
    document.getElementById("languageSelect").addEventListener("change", async function() {
      selectedLang = this.value;
      localStorage.setItem("lang", selectedLang);
      await translateInterface();
    });

    // Инициализация перевода интерфейса при загрузке
    translateInterface();
  </script>
</body>
</html>